<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简图片处理工具</title>
    <!-- 引入 Tailwind CSS 用于快速构建美观的界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Cropper.js 的 CSS 文件 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <style>
        /* 自定义样式，用于美化 Cropper.js 的裁剪框 */
        .cropper-view-box,
        .cropper-face {
            border-radius: 0.5rem;
        }
        .cropper-line,
        .cropper-point {
            background-color: #ffffff;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* 拼接预览图中被选为标准的图片样式 */
        #stitch-preview .preview-item.selected-standard img {
            outline: 4px solid #4f46e5; /* indigo-600 */
            outline-offset: 2px;
        }
        /* 拖拽时的占位符样式 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c7d2fe; /* indigo-200 */
        }
        /* 选中的拼接方向按钮样式 */
        #stitch-controls button.active-direction {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
            background-color: #3730a3; /* A darker shade of indigo */
        }
        /* 删除按钮样式 */
        .delete-btn {
            transition: all 0.2s ease-in-out;
        }
        .preview-item:hover .delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        /* 预览框高度变化的过渡效果 */
        #stitch-preview-wrapper {
            transition: height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white">极简图片处理工具</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">裁剪与拼接</p>
        </header>

        <main>
            <!-- 裁剪功能区 -->
            <section id="cropper-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">1. 图片裁剪</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- 左侧：上传和操作 -->
                    <div>
                        <label for="crop-input" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">选择一张图片：</label>
                        <input type="file" id="crop-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/50 dark:file:text-blue-300 dark:hover:file:bg-blue-900">
                        
                        <div class="mt-6 h-[400px] bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-center items-center">
                            <img id="image-to-crop" class="hidden max-w-full max-h-full">
                        </div>
                    </div>
                    <!-- 右侧：控制、预览和下载 -->
                    <div>
                        <div id="crop-controls" class="hidden">
                            <h3 class="text-lg font-semibold mb-2">裁剪选项</h3>
                            <div class="mb-4">
                                <p class="text-sm font-medium mb-2">按比例裁剪:</p>
                                <div id="aspect-ratio-buttons" class="flex flex-wrap gap-2">
                                    <button data-ratio="free" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-sm font-semibold rounded-md hover:bg-blue-500 hover:text-white">自由</button>
                                    <button data-ratio="1/1" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-sm font-semibold rounded-md hover:bg-blue-500 hover:text-white">1:1</button>
                                    <button data-ratio="4/3" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-sm font-semibold rounded-md hover:bg-blue-500 hover:text-white">4:3</button>
                                    <button data-ratio="16/9" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-sm font-semibold rounded-md hover:bg-blue-500 hover:text-white">16:9</button>
                                    <button id="reset-crop-btn" class="px-3 py-1.5 bg-yellow-400 dark:bg-yellow-600 text-sm font-semibold rounded-md hover:bg-yellow-500 text-white">复位</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2">按像素设定比例:</p>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="crop-width" placeholder="长度" class="w-24 p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm">
                                    <span class="text-gray-500">x</span>
                                    <input type="number" id="crop-height" placeholder="高度" class="w-24 p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-2">裁剪结果预览</h3>
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg h-[200px] flex items-center justify-center p-4">
                               <canvas id="crop-result-canvas" class="max-w-full max-h-full"></canvas>
                            </div>
                        </div>
                        <div class="mt-4 space-x-2">
                             <button id="crop-button" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400" disabled>裁剪</button>
                             <a id="download-crop" class="hidden px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700" href="#" download="cropped_image.png">下载图片</a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 拼接功能区 -->
            <section id="stitch-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">2. 图片拼接</h2>
                 <div class="grid md:grid-cols-2 gap-8">
                    <!-- 左侧：上传和操作 -->
                    <div>
                        <label for="stitch-input" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">选择图片 (可多次添加，上传后可拖拽排序):</label>
                        <input type="file" id="stitch-input" accept="image/*" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900/50 dark:file:text-indigo-300 dark:hover:file:bg-indigo-900">
                        
                        <p id="stitch-hint" class="text-sm text-gray-500 mt-2 hidden">提示：点击下方任一图片，即可将其设为拼接标准。</p>
                        <div id="stitch-preview" class="mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                            <!-- 待拼接图片缩略图将在这里显示 -->
                        </div>

                        <div id="stitch-controls" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-2">拼接方式</h3>
                            <div class="p-4 border rounded-lg dark:border-gray-600 flex flex-wrap items-center gap-2">
                                <button id="stitch-vertical" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 text-sm">竖向拼接</button>
                                <button id="stitch-horizontal" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 text-sm">横向拼接</button>
                                <div class="flex-grow"></div>
                                <button id="clear-all-stitch" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 text-sm">一键清除</button>
                            </div>
                        </div>
                    </div>
                    <!-- 右侧：结果预览和下载 -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">拼接结果预览</h3>
                        <div id="stitch-preview-wrapper" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 overflow-auto h-[200px] flex justify-start items-start">
                            <canvas id="stitch-result-canvas"></canvas>
                        </div>
                        <div class="mt-4">
                            <a id="download-stitch" class="hidden px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700" href="#" download="stitched_image.png">下载拼接图片</a>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 引入 Cropper.js 的 JS 文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <!-- 引入 SortableJS 用于拖拽排序 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 裁剪功能 ---
            const cropInput = document.getElementById('crop-input');
            const imageToCrop = document.getElementById('image-to-crop');
            const cropButton = document.getElementById('crop-button');
            const cropResultCanvas = document.getElementById('crop-result-canvas');
            const downloadCropLink = document.getElementById('download-crop');
            const cropControls = document.getElementById('crop-controls');
            const aspectRatioButtons = document.getElementById('aspect-ratio-buttons');
            const cropWidthInput = document.getElementById('crop-width');
            const cropHeightInput = document.getElementById('crop-height');
            const resetCropBtn = document.getElementById('reset-crop-btn');
            let cropper = null;

            cropInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    imageToCrop.classList.remove('hidden');
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        viewMode: 1,
                        dragMode: 'move', // 允许拖动摇摄图片
                        background: false,
                        autoCropArea: 0.8,
                        responsive: true,
                        toggleDragModeOnDblclick: false, // 禁用双击切换模式
                    });
                    cropButton.disabled = false;
                    cropControls.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });
            
            resetCropBtn.addEventListener('click', () => {
                if (cropper) {
                    cropper.reset();
                }
            });

            aspectRatioButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.ratio) {
                    const ratioStr = e.target.dataset.ratio;
                    const ratio = ratioStr === 'free' ? NaN : eval(ratioStr);
                    cropper.setAspectRatio(ratio);
                }
            });

            const updateAspectRatioFromPixels = () => {
                const width = parseFloat(cropWidthInput.value);
                const height = parseFloat(cropHeightInput.value);
                if (width > 0 && height > 0) {
                    cropper.setAspectRatio(width / height);
                }
            };
            cropWidthInput.addEventListener('input', updateAspectRatioFromPixels);
            cropHeightInput.addEventListener('input', updateAspectRatioFromPixels);

            cropButton.addEventListener('click', () => {
                if (!cropper) return;
                const croppedCanvas = cropper.getCroppedCanvas({ imageSmoothingQuality: 'high' });
                const ctx = cropResultCanvas.getContext('2d');
                cropResultCanvas.width = croppedCanvas.width;
                cropResultCanvas.height = croppedCanvas.height;
                ctx.drawImage(croppedCanvas, 0, 0);
                downloadCropLink.href = cropResultCanvas.toDataURL('image/png');
                downloadCropLink.classList.remove('hidden');
            });

            // --- 拼接功能 ---
            const stitchInput = document.getElementById('stitch-input');
            const stitchResultCanvas = document.getElementById('stitch-result-canvas');
            const downloadStitchLink = document.getElementById('download-stitch');
            const stitchPreviewContainer = document.getElementById('stitch-preview');
            const stitchControls = document.getElementById('stitch-controls');
            const stitchVerticalBtn = document.getElementById('stitch-vertical');
            const stitchHorizontalBtn = document.getElementById('stitch-horizontal');
            const stitchHint = document.getElementById('stitch-hint');
            const clearAllBtn = document.getElementById('clear-all-stitch');
            const stitchPreviewWrapper = document.getElementById('stitch-preview-wrapper');

            let stitchImages = [];
            let selectedStandardIndex = -1;
            let selectedDirection = null;
            let sortable = null;

            const resetStitchArea = () => {
                stitchImages = [];
                if (sortable) {
                    sortable.destroy();
                    sortable = null;
                }
                stitchPreviewContainer.innerHTML = '';
                selectedStandardIndex = -1;
                selectedDirection = null;
                stitchVerticalBtn.classList.remove('active-direction');
                stitchHorizontalBtn.classList.remove('active-direction');
                stitchHint.classList.add('hidden');
                stitchControls.classList.add('hidden');
                const ctx = stitchResultCanvas.getContext('2d');
                ctx.clearRect(0, 0, stitchResultCanvas.width, stitchResultCanvas.height);
                downloadStitchLink.classList.add('hidden');
                stitchInput.value = ''; // 清空文件选择器
                
                // 恢复预览区初始高度
                stitchPreviewWrapper.classList.remove('h-[500px]');
                stitchPreviewWrapper.classList.add('h-[200px]');
            };

            const renderStitchPreviews = () => {
                // If we're about to render an empty list, just reset everything and stop.
                if (stitchImages.length === 0) {
                    resetStitchArea();
                    return;
                }

                // Otherwise, destroy the old sortable instance before re-rendering
                if (sortable) {
                    sortable.destroy();
                    sortable = null;
                }
                stitchPreviewContainer.innerHTML = ''; // 清空现有预览

                stitchImages.forEach((data, index) => {
                    const itemContainer = document.createElement('div');
                    itemContainer.className = 'preview-item relative cursor-pointer';
                    if (index === selectedStandardIndex) {
                        itemContainer.classList.add('selected-standard');
                    }

                    const thumb = document.createElement('img');
                    thumb.src = data.src;
                    thumb.className = 'w-full h-auto object-cover rounded-md';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold opacity-0 scale-75 transform hover:bg-red-600';
                    deleteBtn.innerHTML = '&#x2715;'; // '✕' character
                    deleteBtn.title = '删除此图片';

                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // 防止触发父元素的点击事件（选择标准图）
                        stitchImages.splice(index, 1);
                        // 如果删除的是标准图，重置标准
                        if (index === selectedStandardIndex) {
                            selectedStandardIndex = -1;
                        } else if (index < selectedStandardIndex) {
                            selectedStandardIndex--; // 如果删除的是标准图前面的图，索引要减一
                        }
                        renderStitchPreviews(); // 重新渲染预览区
                        if(selectedDirection) stitch({ direction: selectedDirection }); // 如果有方向，刷新拼接结果
                    });

                    itemContainer.appendChild(thumb);
                    itemContainer.appendChild(deleteBtn);
                    stitchPreviewContainer.appendChild(itemContainer);

                    itemContainer.addEventListener('click', () => {
                        selectStandard(index);
                    });
                });
                
                stitchControls.classList.remove('hidden');
                stitchHint.classList.remove('hidden');

                sortable = new Sortable(stitchPreviewContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const movedItem = stitchImages.splice(evt.oldIndex, 1)[0];
                        stitchImages.splice(evt.newIndex, 0, movedItem);

                        if (selectedStandardIndex === evt.oldIndex) {
                            selectedStandardIndex = evt.newIndex;
                        } else if (evt.oldIndex < selectedStandardIndex && evt.newIndex >= selectedStandardIndex) {
                            selectedStandardIndex--;
                        } else if (evt.oldIndex > selectedStandardIndex && evt.newIndex <= selectedStandardIndex) {
                            selectedStandardIndex++;
                        }
                        
                        // 重新渲染以更新DOM和事件，确保一致性
                        renderStitchPreviews();

                        if(selectedDirection) {
                            stitch({ direction: selectedDirection });
                        }
                    },
                });
            };

            stitchInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length === 0) return;

                const promises = Array.from(files).map((file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => resolve({ img, src: event.target.result });
                            img.onerror = reject;
                            img.src = event.target.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(newImageData => {
                    stitchImages.push(...newImageData); // 追加新图片
                    renderStitchPreviews(); // 渲染所有预览
                }).catch(error => console.error("图片加载失败:", error));
                 
                e.target.value = ''; // 允许重复选择相同的文件
            });

            clearAllBtn.addEventListener('click', resetStitchArea);

            function selectStandard(index) {
                if (selectedStandardIndex === index) {
                    selectedStandardIndex = -1;
                } else {
                    selectedStandardIndex = index;
                }
                
                // 只更新样式，不重新渲染整个列表
                Array.from(stitchPreviewContainer.children).forEach((el, i) => {
                    if (i === selectedStandardIndex) {
                        el.classList.add('selected-standard');
                    } else {
                        el.classList.remove('selected-standard');
                    }
                });

                if (selectedDirection) {
                    stitch({ direction: selectedDirection });
                }
            }
            
            stitchVerticalBtn.addEventListener('click', () => {
                selectedDirection = 'vertical';
                stitchVerticalBtn.classList.add('active-direction');
                stitchHorizontalBtn.classList.remove('active-direction');
                stitch({ direction: 'vertical' });
            });

            stitchHorizontalBtn.addEventListener('click', () => {
                selectedDirection = 'horizontal';
                stitchHorizontalBtn.classList.add('active-direction');
                stitchVerticalBtn.classList.remove('active-direction');
                stitch({ direction: 'horizontal' });
            });

            function stitch({ direction }) {
                if (stitchImages.length < 2) {
                     const ctx = stitchResultCanvas.getContext('2d');
                     ctx.clearRect(0, 0, stitchResultCanvas.width, stitchResultCanvas.height);
                     downloadStitchLink.classList.add('hidden');
                     stitchPreviewWrapper.classList.remove('h-[500px]');
                     stitchPreviewWrapper.classList.add('h-[200px]');
                     return;
                }
                
                // 拼接时，智能调整预览区高度
                if (direction === 'vertical') {
                    stitchPreviewWrapper.classList.remove('h-[200px]');
                    stitchPreviewWrapper.classList.add('h-[500px]');
                } else {
                    stitchPreviewWrapper.classList.remove('h-[500px]');
                    stitchPreviewWrapper.classList.add('h-[200px]');
                }
                
                const originalImages = stitchImages.map(data => data.img);
                const isStandardMode = selectedStandardIndex !== -1;
                
                let scaledDims;

                if (isStandardMode) {
                    const standardImage = originalImages[selectedStandardIndex];
                    scaledDims = originalImages.map(img => {
                        if (img === standardImage) {
                            return { width: img.width, height: img.height };
                        }
                        const ratio = img.width / img.height;
                        let newWidth, newHeight;
                        if (direction === 'vertical') {
                            newWidth = standardImage.width;
                            newHeight = Math.round(newWidth / ratio);
                        } else { // horizontal
                            newHeight = standardImage.height;
                            newWidth = Math.round(newHeight * ratio);
                        }
                        return { width: newWidth, height: newHeight };
                    });
                } else {
                    scaledDims = originalImages.map(img => ({ width: img.width, height: img.height }));
                }
                
                drawStitchedImage(direction, originalImages, scaledDims);
            }

            function drawStitchedImage(direction, images, dims) {
                let totalWidth = 0, totalHeight = 0;
                const ctx = stitchResultCanvas.getContext('2d');
                
                // 重置样式，为新的智能缩放做准备
                stitchResultCanvas.style.width = 'auto';
                stitchResultCanvas.style.height = 'auto';
                stitchResultCanvas.style.maxWidth = 'none';
                stitchResultCanvas.style.maxHeight = 'none';

                if (direction === 'vertical') {
                    totalWidth = Math.max(...dims.map(d => d.width));
                    totalHeight = dims.reduce((sum, d) => sum + d.height, 0);
                    stitchResultCanvas.width = totalWidth;
                    stitchResultCanvas.height = totalHeight;
                    let currentY = 0;
                    images.forEach((img, index) => {
                        const d = dims[index];
                        ctx.drawImage(img, (totalWidth - d.width) / 2, currentY, d.width, d.height);
                        currentY += d.height;
                    });
                } else {
                    totalWidth = dims.reduce((sum, d) => sum + d.width, 0);
                    totalHeight = Math.max(...dims.map(d => d.height));
                    stitchResultCanvas.width = totalWidth;
                    stitchResultCanvas.height = totalHeight;
                    let currentX = 0;
                    images.forEach((img, index) => {
                        const d = dims[index];
                        ctx.drawImage(img, currentX, (totalHeight - d.height) / 2, d.width, d.height);
                        currentX += d.width;
                    });
                }

                // 智能预览逻辑
                const container = stitchPreviewWrapper;
                const containerWidth = container.clientWidth - 32;
                const containerHeight = container.clientHeight - 32;

                if (totalWidth <= containerWidth && totalHeight <= containerHeight) {
                    // 图片很小，不需要缩放
                } else {
                    // 图片很大，应用单向滚动
                    if (direction === 'vertical') {
                        stitchResultCanvas.style.width = '100%';
                        stitchResultCanvas.style.height = 'auto';
                    } else { // horizontal
                        stitchResultCanvas.style.height = '100%';
                        stitchResultCanvas.style.width = 'auto';
                    }
                }

                downloadStitchLink.href = stitchResultCanvas.toDataURL('image/png');
                downloadStitchLink.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
